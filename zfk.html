<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ›æ„é’¢ç´é”®ç›˜ - å¼ å³°æºåŸåˆ›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#FF7D00',
                        dark: '#1E293B',
                        light: '#F8FAFC',
                        accent: '#7C3AED'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .key-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 -4px 0 0 rgba(0, 0, 0, 0.1);
            }
            .key-shadow-active {
                box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), inset 0 -2px 0 0 rgba(0, 0, 0, 0.1);
            }
            .black-key {
                position: absolute;
                width: 14%;
                height: 60%;
                background-color: #333;
                z-index: 10;
                margin-left: -7%;
                border-radius: 0 0 6px 6px;
            }
            .floating-note {
                position: absolute;
                pointer-events: none;
                font-size: 1.5rem;
                font-weight: bold;
                opacity: 0;
                transition: all 0.8s ease-out;
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            .recording-indicator {
                animation: blink 1.5s infinite;
            }
            @keyframes blink {
                0% { opacity: 1; }
                50% { opacity: 0.4; }
                100% { opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-blue-100 min-h-screen font-inter flex flex-col p-4 md:p-6">
    <div class="w-full max-w-4xl mx-auto flex-1 flex flex-col">
        <header class="text-center mb-4 md:mb-6 pt-2 md:pt-0">
            <h1 class="text-[clamp(1.5rem,6vw,2.5rem)] font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent mb-1 md:mb-2">åˆ›æ„é’¢ç´é”®ç›˜</h1>
            <p class="text-gray-600 text-sm md:text-lg">å¼ å³°æºåŸåˆ› | ä¸æ­¢äºå¼¹å¥çš„éŸ³ä¹ä½“éªŒ</p>
        </header>
        
        <main class="bg-white rounded-2xl shadow-xl p-4 md:p-6 flex-1 flex flex-col">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="mb-4 flex flex-wrap gap-3 items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="record-btn" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-all">
                        <i class="fa fa-circle-o text-sm"></i>
                        <span class="text-sm md:text-base">å½•éŸ³</span>
                    </button>
                    <button id="play-btn" class="flex items-center gap-2 bg-primary hover:bg-primary/90 text-white px-3 py-2 rounded-lg transition-all opacity-50 cursor-not-allowed">
                        <i class="fa fa-play"></i>
                        <span class="text-sm md:text-base">æ’­æ”¾</span>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <label for="instrument" class="text-sm md:text-base text-gray-700">ä¹å™¨:</label>
                    <select id="instrument" class="bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="sine">é’¢ç´</option>
                        <option value="square">ç”µå­ç´</option>
                        <option value="triangle">å°æç´</option>
                        <option value="sawtooth">è¨å…‹æ–¯</option>
                    </select>
                </div>
            </div>
            
            <!-- é”®ç›˜åŒºåŸŸ -->
            <div class="keyboard-container relative w-full flex-1 max-w-3xl mx-auto mb-4" style="min-height: 200px;">
                <div id="keyboard" class="relative w-full h-full flex rounded-lg overflow-hidden shadow-lg">
                    <!-- ç´é”®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div id="note-display" class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 md:mb-4 bg-primary text-white px-4 py-2 md:px-6 md:py-3 rounded-lg shadow-lg text-sm md:text-xl font-semibold transition-all duration-300 opacity-0">
                    <span id="note-name">C</span>
                </div>
                
                <!-- éŸ³ç¬¦åŠ¨ç”»å®¹å™¨ -->
                <div id="notes-container" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
            </div>
            
            <!-- å½•éŸ³æç¤ºå’Œç¤ºä¾‹æ—‹å¾‹ -->
            <div class="mt-2 md:mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                    <p class="text-sm md:text-base text-gray-700 flex items-center gap-2">
                        <i class="fa fa-lightbulb-o text-secondary"></i>
                        <span>å½•éŸ³åå¯ä»¥æ’­æ”¾æ‚¨çš„åˆ›ä½œ</span>
                    </p>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                    <div class="flex items-center justify-between">
                        <p class="text-sm md:text-base text-gray-700 flex items-center gap-2">
                            <i class="fa fa-music text-accent"></i>
                            <span>ç¤ºä¾‹æ—‹å¾‹</span>
                        </p>
                        <div class="flex gap-2">
                            <button class="demo-melody bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-xs md:text-sm transition-all" data-melody="simple">ç®€å•</button>
                            <button class="demo-melody bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded text-xs md:text-sm transition-all" data-melody="happy">æ¬¢å¿«</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="mt-4 md:mt-6 text-center text-gray-500 text-xs md:text-sm">
            <p>ğŸ¹ åˆ›æ„é’¢ç´ | è®©éŸ³ä¹åˆ›ä½œæ›´æœ‰è¶£</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // å®šä¹‰éŸ³ç¬¦å’Œå¯¹åº”çš„éŸ³é¢‘é¢‘ç‡
            const notes = [
                { name: 'C', frequency: 261.63, keyCode: 65 }, // Aé”®
                { name: 'D', frequency: 293.66, keyCode: 83 }, // Sé”®
                { name: 'E', frequency: 329.63, keyCode: 68 }, // Dé”®
                { name: 'F', frequency: 349.23, keyCode: 70 }, // Fé”®
                { name: 'G', frequency: 392.00, keyCode: 71 }, // Gé”®
                { name: 'A', frequency: 440.00, keyCode: 72 }, // Hé”®
                { name: 'B', frequency: 493.88, keyCode: 74 }, // Jé”®
                { name: 'C1', frequency: 523.25, keyCode: 75 }  // Ké”®
            ];
            
            // ç¤ºä¾‹æ—‹å¾‹
            const melodies = {
                simple: [
                    {note: 'C', time: 0},
                    {note: 'D', time: 500},
                    {note: 'E', time: 1000},
                    {note: 'C', time: 1500},
                    {note: 'C', time: 2000},
                    {note: 'D', time: 2500},
                    {note: 'E', time: 3000},
                    {note: 'C', time: 3500}
                ],
                happy: [
                    {note: 'C1', time: 0},
                    {note: 'B', time: 300},
                    {note: 'A', time: 600},
                    {note: 'G', time: 900},
                    {note: 'G', time: 1200},
                    {note: 'A', time: 1500},
                    {note: 'B', time: 1800},
                    {note: 'C1', time: 2100}
                ]
            };
            
            // è·å–DOMå…ƒç´ 
            const keyboard = document.getElementById('keyboard');
            const noteDisplay = document.getElementById('note-display');
            const noteName = document.getElementById('note-name');
            const notesContainer = document.getElementById('notes-container');
            const recordBtn = document.getElementById('record-btn');
            const playBtn = document.getElementById('play-btn');
            const instrumentSelect = document.getElementById('instrument');
            const demoButtons = document.querySelectorAll('.demo-melody');
            
            // å½•éŸ³ç›¸å…³å˜é‡
            let isRecording = false;
            let recordedNotes = [];
            let recordingStartTime = 0;
            
            // éŸ³é¢‘ä¸Šä¸‹æ–‡
            let audioContext;
            let currentOscillators = [];
            
            // åˆ›å»ºç´é”®
            notes.forEach((note, index) => {
                // åˆ›å»ºç™½è‰²ç´é”®
                const key = document.createElement('div');
                key.className = 'white-key flex-1 relative bg-white border-r border-gray-300 cursor-pointer transition-all duration-150 key-shadow flex flex-col items-center justify-end pb-2 md:pb-4';
                key.dataset.note = note.name;
                key.dataset.frequency = note.frequency;
                key.dataset.keycode = note.keyCode;
                
                // å“åº”å¼ç´é”®æ–‡å­—
                key.innerHTML = `
                    <span class="text-xs md:text-lg font-semibold text-gray-800">${note.name}</span>
                    <span class="text-[8px] md:text-xs text-gray-500 mt-0.5">${String.fromCharCode(note.keyCode)}</span>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                key.addEventListener('mousedown', () => playNote(key));
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    playNote(key);
                });
                
                key.addEventListener('mouseup', () => stopNote(key));
                key.addEventListener('touchend', () => stopNote(key));
                key.addEventListener('mouseleave', () => stopNote(key));
                key.addEventListener('touchcancel', () => stopNote(key));
                
                keyboard.appendChild(key);
            });
            
            // æ’­æ”¾éŸ³ç¬¦
            function playNote(key) {
                // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // è·å–éŸ³ç¬¦ä¿¡æ¯
                const note = key.dataset.note;
                const frequency = parseFloat(key.dataset.frequency);
                
                // æ˜¾ç¤ºå½“å‰éŸ³ç¬¦
                noteName.textContent = note;
                noteDisplay.style.opacity = '1';
                noteDisplay.style.transform = 'translate(-50%, -5px)';
                
                // æ”¹å˜ç´é”®æ ·å¼
                key.classList.remove('key-shadow');
                key.classList.add('key-shadow-active', 'bg-gray-100');
                
                // åˆ›å»ºæŒ¯è¡å™¨æ’­æ”¾éŸ³ç¬¦
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                // æ ¹æ®é€‰æ‹©çš„ä¹å™¨è®¾ç½®æ³¢å½¢
                oscillator.type = instrumentSelect.value;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                // éŸ³é‡æ¸å˜ï¼Œä½¿å£°éŸ³æ›´è‡ªç„¶
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.05);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                
                // å­˜å‚¨å½“å‰çš„éŸ³é¢‘èŠ‚ç‚¹
                key.currentOscillator = oscillator;
                key.currentGainNode = gainNode;
                currentOscillators.push({key, oscillator, gainNode});
                
                // åˆ›å»ºéŸ³ç¬¦åŠ¨ç”»
                createFloatingNote(note, key);
                
                // å¦‚æœæ­£åœ¨å½•éŸ³ï¼Œè®°å½•éŸ³ç¬¦
                if (isRecording) {
                    recordedNotes.push({
                        note,
                        frequency,
                        time: Date.now() - recordingStartTime
                    });
                }
            }
            
            // åœæ­¢éŸ³ç¬¦
            function stopNote(key) {
                if (key.currentOscillator) {
                    // éŸ³é‡æ·¡å‡º
                    key.currentGainNode.gain.linearRampToValueAtTime(
                        0, 
                        audioContext.currentTime + 0.1
                    );
                    
                    // åœæ­¢æŒ¯è¡å™¨
                    setTimeout(() => {
                        key.currentOscillator.stop();
                        key.currentOscillator = null;
                        key.currentGainNode = null;
                        
                        // ä»å½“å‰æŒ¯è¡å™¨åˆ—è¡¨ä¸­ç§»é™¤
                        currentOscillators = currentOscillators.filter(item => item.key !== key);
                    }, 100);
                }
                
                // æ¢å¤ç´é”®æ ·å¼
                key.classList.remove('key-shadow-active', 'bg-gray-100');
                key.classList.add('key-shadow');
                
                // éšè—éŸ³ç¬¦æ˜¾ç¤ºï¼ˆå»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼‰
                setTimeout(() => {
                    if (currentOscillators.length === 0) {
                        noteDisplay.style.opacity = '0';
                        noteDisplay.style.transform = 'translate(-50%, 0)';
                    }
                }, 300);
            }
            
            // åˆ›å»ºæ¼‚æµ®éŸ³ç¬¦åŠ¨ç”»
            function createFloatingNote(note, key) {
                const floatingNote = document.createElement('div');
                floatingNote.className = 'floating-note';
                
                // éšæœºé¢œè‰²
                const colors = ['#165DFF', '#FF7D00', '#7C3AED', '#10B981', '#EF4444'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                floatingNote.style.color = randomColor;
                floatingNote.textContent = note;
                
                // å®šä½åœ¨ç´é”®ä¸Šæ–¹
                const rect = key.getBoundingClientRect();
                const containerRect = notesContainer.getBoundingClientRect();
                
                floatingNote.style.left = `${rect.left + rect.width/2 - containerRect.left}px`;
                floatingNote.style.bottom = `${rect.height - containerRect.top}px`;
                
                notesContainer.appendChild(floatingNote);
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    floatingNote.style.transform = `translate(-50%, -150px) rotate(15deg)`;
                    floatingNote.style.opacity = '0.8';
                }, 10);
                
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    floatingNote.remove();
                }, 800);
            }
            
            // å½•éŸ³æŒ‰é’®äº‹ä»¶
            recordBtn.addEventListener('click', () => {
                isRecording = !isRecording;
                
                if (isRecording) {
                    // å¼€å§‹å½•éŸ³
                    recordedNotes = [];
                    recordingStartTime = Date.now();
                    recordBtn.innerHTML = `
                        <i class="fa fa-circle text-sm recording-indicator"></i>
                        <span class="text-sm md:text-base">æ­£åœ¨å½•éŸ³</span>
                    `;
                    recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                    recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    playBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    // åœæ­¢å½•éŸ³
                    recordBtn.innerHTML = `
                        <i class="fa fa-circle-o text-sm"></i>
                        <span class="text-sm md:text-base">å½•éŸ³</span>
                    `;
                    recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    
                    // å¦‚æœæœ‰å½•éŸ³å†…å®¹ï¼Œå¯ç”¨æ’­æ”¾æŒ‰é’®
                    if (recordedNotes.length > 0) {
                        playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });
            
            // æ’­æ”¾æŒ‰é’®äº‹ä»¶
            playBtn.addEventListener('click', () => {
                if (recordedNotes.length === 0) return;
                
                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æ’­æ”¾
                playBtn.disabled = true;
                playBtn.classList.add('opacity-70');
                
                // æ’­æ”¾å½•éŸ³
                recordedNotes.forEach(note => {
                    setTimeout(() => {
                        const key = Array.from(keyboard.children).find(
                            k => k.dataset.note === note.note
                        );
                        if (key) {
                            playNote(key);
                            setTimeout(() => stopNote(key), 300);
                        }
                    }, note.time);
                });
                
                // è®¡ç®—æ€»æ’­æ”¾æ—¶é—´ï¼Œç„¶åé‡æ–°å¯ç”¨æŒ‰é’®
                const totalTime = recordedNotes[recordedNotes.length - 1].time + 500;
                setTimeout(() => {
                    playBtn.disabled = false;
                    playBtn.classList.remove('opacity-70');
                }, totalTime);
            });
            
            // ç¤ºä¾‹æ—‹å¾‹æŒ‰é’®
            demoButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const melodyName = btn.dataset.melody;
                    const melody = melodies[melodyName];
                    
                    // æ’­æ”¾ç¤ºä¾‹æ—‹å¾‹
                    melody.forEach(item => {
                        setTimeout(() => {
                            const key = Array.from(keyboard.children).find(
                                k => k.dataset.note === item.note
                            );
                            if (key) {
                                playNote(key);
                                setTimeout(() => stopNote(key), 250);
                            }
                        }, item.time);
                    });
                });
            });
            
            // é”®ç›˜å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', (e) => {
                if (e.repeat) return; // é˜²æ­¢æŒ‰ä½é”®é‡å¤è§¦å‘
                
                const key = Array.from(keyboard.children).find(
                    k => parseInt(k.dataset.keycode) === e.keyCode
                );
                
                if (key) {
                    playNote(key);
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const key = Array.from(keyboard.children).find(
                    k => parseInt(k.dataset.keycode) === e.keyCode
                );
                
                if (key) {
                    stopNote(key);
                }
            });
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // æ’­æ”¾ä¸€ä¸ªæçŸ­çš„é™éŸ³æ¥åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = 0;
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.01);
                }
            }

            // ç›‘å¬ç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼Œåˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            document.addEventListener('click', initAudioContext, { once: true });
            document.addEventListener('touchstart', initAudioContext, { once: true });
        });
    </script>
</body>
</html>
    